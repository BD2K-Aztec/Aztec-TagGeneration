hihmm: bayesian non-parametric joint inference of chromatin state maps motivation: genome-wide mapping of chromatin states is essential for defining regulatory elements and inferring their activities in eukaryotic genomes. a number of hidden markov model (hmm)-based methods have been developed to infer chromatin state maps from genome-wide his-tone modification data for an individual genome. to perform a principled comparison of evolution-arily distant epigenomes, we must consider species-specific biases such as differences in genome size, strength of signal enrichment and co-occurrence patterns of histone modifications. results: here, we present a new bayesian non-parametric method called hierarchically linked infinite hmm (hihmm) to jointly infer chromatin state maps in multiple genomes (different species, cell types and developmental stages) using genome-wide histone modification data. this flexible framework provides a new way to learn a consistent definition of chromatin states across multiple genomes, thus facilitating a direct comparison among them. we demonstrate the utility of this method using synthetic data as well as multiple modencode chip-seq datasets. conclusion: the hierarchical and bayesian non-parametric formulation in our approach is an important extension to the current set of methodologies for comparative chromatin landscape analysis. availability and implementation: source codes are available at https://github.com/kasohn/hihmm.readout of genetic information in eukaryotic genomes is mediated by the dynamic chromatin environment, which regulates dna accessibility for the gene expression machinery through chromatin compaction, associated histone modifications and incorporation of histone variants. chromatin immunoprecipitation experiments followed by genome-wide microarray (chip-chip) or sequencing (chip-seq) have revealed that distinct genomic regulatory regions are associated with different covalent modifications of histone proteins across various organisms . for example, h3k4me3 (trimethylation of histone h3 at residue lysine 4) marks active promoters, h3k4me1 marks enhancers, h3k36me3 marks transcribed gene bodies, h3k27me3 marks polycombrepressed regions and h3k9me3 marks heterochromatin. although there are theoretically up to 2 n possible combinations of n histone modifications at any given locus in the genome, in practice we only observe a small number of distinct dominant combinations, thus giving rise to the concept of chromatin states , in which each state consists of a combination of histone modifications. a key idea underlying chromatin state analysis is to computationally identify the number and composition of chromatin states in the genome based on multiple genome-wide profiles of histone modifications and to annotate the genome with these chromatin states. these states were found to be strongly correlated with various functional genomic features such as promoters, actively transcribing gene bodies, enhancers and heterochromatins. although many chromatin states are common across different cell types or organisms, there are indeed clear examples of cell-type-specific chromatin states consisting of unique co-occurrence of histone modifications. the h3k4me3/h3k27me3 bivalent promoter state that is prevalent in embryonic stem cells but mostly absent from terminally differentiated cells is such an example . investigating co-occurrence of multiple histone marks facilitates the differentiation of more subtle features in chromatin state, such as identifying tissue-specific strong and weak enhancer regions and changes in co-occurrence patterns between evolutionarily distant species . therefore, a chromatin state map is a powerful means to infer potential genome function in a systematic and automated fashion. in conjunction with transcriptomic, dnase i and transcription factor binding data, chromatin state analysis was used to infer putative biochemical functions to a large fraction of the non-coding genomic regions (encode project). various machine learning algorithms, such as chromhmm , segway , treehmm and tiered hmm , have been developed to generate such maps to facilitate cell type-specific genome annotations in a systematic and automated fashion. all of them are based on probabilistic graphical models such as the hidden markov model (hmm) and dynamic bayesian network. one essential task for these algorithms is to learn the prominent combination of histone modifications. similar to any clustering problem, it is often difficult to identify a reasonable number of combinations that can adequately capture the major variation in the data. one possibility is to estimate the adequate number of states by performing exploratory analysis such as the principal component analysis . another common approach is to run the hmm learning multiple times with varying state numbers and identify the best fitting model using measures such as the bayesian information criterion. the inferred states do not necessarily have a one-to-one correspondence with distinct functional regions in the chromatin, but they do give a very good data-driven description of the chromatin that can act as a starting point for further bioinformatics and experimental analysis . therefore, it is still of great interest to develop principled methods for identifying chromatin states within and across multiple genomes.the cross-species chromatin state comparison problem was motivated by a recent model organism encyclopedia of dna elements (modendcode) project that aims to systematically compare chromatin organization in homo sapiens (human), drosophila melanogaster (fly) and caenorhabditis elegans (worm) . a navenave approach to this problem would be to compute the state map for each organism separately and then try to compare them afterward. however, this causes significant problems for interpretation because what was defined as an enhancer state in one organism is likely not identical with that from another organism. in the other extreme, we could simply concatenate the three genomes into one and infer states, but then the inferred result would be highly biased by the species with the largest genome size or by other species-specific biases in the chip-seq signals. similar problems exist when comparing multiple developmental stages or cell types in the same organism. in essence, we require a method that allows the information of the state definition to be shared across multiple genomes while retaining the ability for each genome to have its own chromatin state definition. in the context of that project, we developed a novel bayesian non-parametric method, called hierarchically linked infinite hmm (hihmm), to infer chromatin state maps across multiple genomes simultaneously. the application of hihmm in the human/fly/worm cross-species comparison setting indicates that the chromatin state segmentations in individual organisms generated by hihmm are highly comparable to the maps generated by chromhmm and segway two widely used chromatin state segmentation algorithms . furthermore, hihmm is designed to address species-specific confounding factors such as variations in chip signal strength, genome size and co-occurrence patterns. in this article, we will present the method in detail as well as demonstrating the utility of this method using a variety of simulated and real data.the main innovation of our approach is that it provides a flexible framework to enable information sharing between multiple hmms.the main difficulty of joint analysis of related datasets is how to obtain a consistent state definition or the mapping between a set of states defined in one species and the one in another species. if one were to apply ihmm separately on each of the datasets, we face the problem of mapping state definitions between species. the proposed hihmm solves this problem by assuming a common state space definition across all the datasets. it is one of the main advantages of using the non-parametric model based on the so-called hierarchical dp, which is the core component of ihmm. under a hierarchical dp prior for data from multiple groups, each group is associated with a group-specific dp and then those dps share a common base measure that is another dp. this is the major mechanism how the atoms from each dp can be shared across groups. model 1 couples the state definition more loosely than model 2 since in model 1 information is shared via the prior only, whereas model 2 explicitly employs a shared emission matrix. one distinguishing feature of hihmm is that we can jointly infer emission values for genomes of differing lengths without the dominating influence of a longer genome on the result or the need to perform compensatory subsampling during training. this is a major limitation of existing methods that concatenate multiple samples for joint learning that is overcome using hihmm. similar to segway or the hmm approach of, hihmm directly models continuous chip signal values and therefore alleviate the need of selecting a binary threshold cutoff. we observe that this feature is potentially important forf : fly w : wormdifferentiating within a class of similar states, highlighted by the interesting and diverse characteristics we observe in low signal states (supplementary). both our simulated and real data analyses show that the advantages of model 1 become more evident when the data discrepancy across different conditions is large, for example, in the case of multiple species data. in terms of revealing interesting biology, the ability to infer sample-specific emission matrix parameters (as in model 1) allows for intuitive and detailed comparison of chromatin mark combinations between different species or cell types. this is evident from our 25 state analyses in fly versus worm in case study 1. in addition to the finding that fly and worm have different chromatin modifications compositions in heterochromatin, here we observed several previously unreported differences between the two species as described above, most notably the relative depletion of h3k23ac and enrichment of h3k79me1 in fly promoter states, as well as multiple differences in the transcription states. model 1 was also useful in identifying the unexpected changes in the distribution of h3k79me1 during fly development. many of these observations were not possible in previous studies that did not include these marks in their comparison (supplementary), and they may suggest different mechanisms of genetic regulation between the two species. jointly learned and shared emission matrix parameters (as generated by model 2) provide an easily interpretable platform on which to compare multiple samples from the same genome without the confounding factor of different state definitions. additionally, model 2 enjoys better statistical properties such as faster convergence and shorter running time, so model 2 would be a better choice when the discrepancy between genomes is expected to be relatively small as in the case of different developmental stages or environmental conditions in a single species. by applying hihmm to this newly compiled dataset, we were able to identify two previously uncharacterized chromatin states that we have named repressed states in the fly development analysis (states 17 and 18 in). these two states combined constitute roughly 18 of the fly genome and are almost exclusively characterized by marks that were not profiled in previous studies, and so these states were missed. although hihmm allows learning the optimal number of states from the data in principle, the likelihood surface of the model over. chromatin state characterization and analysis across developmental stages in fly. (a) chip signal matrix showing the average observed histone modification profiles for each of 25 states jointly inferred by the hihmm algorithm (model 2) for three stages of fly development: late embryo (el), stage 3 larvae (l3) and adult head (ah). (b) percentage of genome covered by the state (coverage), relative enrichment of expressed genes per state (expression odds ratio) and the percentage of state annotations that occur between the tss and tes of annotated genes (gene body overlap). (c) chromatin state co-occurrence between two developmental stages in fly (el and ah). the observed versus expected fold change of the co-occurrence of each state in el and each state in ah is shown. on the basis of this analysis, we selected significantly over represented co-occurrence regions to investigate and characterize the genes involved through gene set enrichment analyses. (d) genome browser views of representative genes ubx and oamb with three stage chromatin states. these genes were identified through chromatin state co-occurrence analysis as having different chromatin states in el and ah. (e) the top 10 go biological processes enriched in the genes that are within regions of the genome that changed from an active state in el to a repressive state it ah (top panel) or vice versa (bottom panel) hihmm for joint chromatin state inferencethe used parameter space is quite flat. therefore, similar posterior probability value can be obtained through different parameter value combinations, and this makes the recovery of the correct number of states still challenging. for systematic analysis of this issue, we examined the effect on the accuracy and the number of inferred states of three hyper-parameters: the initial number of states k 0 and the two variance parameters: r 2 0 in the prior distribution for the emission matrix and r 2 for generating the observation signal given the hidden state and the emission matrix (supplementary figs. s15 and s16 for model 1 and model 2, respectively). the smaller r 2 produced better segmentation accuracy, which is expected as the variance in the emission model should be small enough to assign the observation signal to the correct state. assuming proper normalization by variance, r 2 1 seems to produce the best result. the number of inferred states depended on all the three parameters but most significantly by r 2 0. we see that r 2 0 should be large enough to compactly capture the varying signals from enriched marks as the prior mean for the emission matrix is zero. for large r 2 0 (2), the number of inferred states becomes less affected by other parameters. the deviation from the initial number of states to the inferred number is also mostly determined by r 2 0 but not significantly by others. it appears to be a good practice to set r 2 0 to be around the mean signal strength of the enriched marks. the initial number of states should be selected close to the true number of states. automatic estimation of these hyper-parameters would need further investigation in our future work. another important issue is to get a reasonably good initial state assignment, which encourages consistent state-definition across species. this issue is especially critical with hihmm1 in which the species-specific models are loosely connected. our current joint initialization scheme of concatenating different genomes as one and applying k-means clustering works reasonably well, but this would be investigated further in our future study. in this article, we demonstrated a variety of features of hihmm that makes it useful for cross-sample joint chromatin state inference. we have devised two models of hihmm, each having advantages and limitations of interpretation and inference. the flexibility of using both learning models allows for a more comprehensive analysis during different applications and experimental designs.  
