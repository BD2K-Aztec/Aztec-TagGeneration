efficient spatial segmentation of large imaging mass spectrometry datasets with spatially aware clustering motivation: imaging mass spectrometry (ims) is one of the few measurement technology s of biochemistry which, given a thin sample, is able to reveal its spatial chemical composition in the full molecular range. ims produces a hyperspectral image, where for each pixel a high-dimensional mass spectrum is measured. currently, the technology is mature enough and one of the major problems preventing its spreading is the under-development of computational methods for mining huge ims datasets. this article proposes a novel approach for spatial segmentation of an ims dataset, which is constructed considering the important issue of pixel-to-pixel variability. methods: we segment pixels by clustering their mass spectra. importantly, we incorporate spatial relations between pixels into clustering, so that pixels are clustered together with their neighbors. we propose two methods. one is non-adaptive, where pixel neighborhoods are selected in the same manner for all pixels. the second one respects the structure observable in the data. for a pixel, its neighborhood is defined taking into account similarity of its spectrum to the spectra of adjacent pixels. both methods have the linear complexity and require linear memory space (in the number of spectra). results: the proposed segmentation methods are evaluated on two ims datasets: a rat brain section and a section of a neuroendocrine tumor. they discover anatomical structure, discriminate the tumor region and highlight functionally similar regions. moreover, our methods provide segmentation maps of similar or better quality if compared to the other state-of-the-art methods, but outperform them in runtime and/or required memory. contact: theodore@math.uni-bremen.degiven a thin sample (usually a tissue slice), imaging mass spectrometry (ims) measures high-dimensional mass spectra at its spatial points, providing a hyperspectral image with a mass spectrum measured at each pixel . each mass spectrum dimension represents the abundance of molecules with this molecular mass. currently, ims is one of the few biochemical technologies able to establish the spatial biochemical composition of the sample in the full molecular range (small and large molecules, e.g. metabolites, lipids and proteins). since 1970s, secondary ion mass spectrometry was the main ims technique for surface analysis , although being unable to measure large molecules (e.g. peptides and proteins). with the to whom correspondence should be addressed. advent of matrix-assisted laser desorption ionization (maldi) imaging mass spectrometry , the measurement of peptides and proteins became possible what opened ims a door to the variety of biological and biomedical problems. currently, ims is one of the most promising innovative measurement techniques in biochemistry. ims has proven its potential in discovery of new drugs and cancer biomarkers just to mention a few important applications. ims was used in numerous studies leading to understanding chemical composition and biological processes, see recent reviews on this topic (amstalden van). as for many modern biochemical techniques, in particular in proteomics , the development of computational methods for ims is lagging behind the technological progress. two unsupervised problems are currently considered in ims data processing: (i) data representation using principal component analysis (pca) and its variants , the technique standardly used for processing sims data, and (ii) spatial segmentation of an ims dataset by means of spectra (or pixels) clustering . concerning the second problem, the spatial segmentation of an ims dataset, several approaches have been proposed. first, straightforward clustering of mass spectra, e.g. k-means . second, feature extraction with pca and then hierarchical clustering of features . hierarchical clustering has an advantage of interactive analysis of the clustering dendrogram but needs to keep in memory the full distance matrix; several work-arounds have been proposed but none is accepted as a standard. the main drawback of using straightforward clustering of mass spectra is that it is negatively affected by the pixel-to-pixel variability issue , which is especially serious in the most popular ims techniques, sims and maldiims. underestimation of this issue leads to strong noise in the resulted segmentation maps . as we show later, the method combining pca with hierarchical clustering is also prone to this problem. we have recently proposed a spatial segmentation method solving this important issue, where edge-preserving spatiallyadaptive denoising is applied to gray-scale images of selected masses prior to clustering . the produced segmentation maps are significantly better than those produced without using denoising, in terms of lack of noise, discrimination of anatomical and histological details, and the number of visible regions. however, these improvements are achieved in full at a cost of using a computationally intensivepage: i231 i230i238in this section, we analyze in detail the results for the rat brain dataset. then, we show segmentation maps for the neuroendocrine tumor dataset.clustering algorithm: k-means was selected as a clustering algorithm after the fastmap projection because it is a fast and reliable algorithm. moreover, k-means optimizes the euclidean distances between the points, see e.g. chapter 14.3.6 of (publicly available online). thus, performing k-means in the space after fastmap projection (for both sa and sasa) is equivalent to minimize the within-point scatter between spectra where the distance between two spectra is calculated using equations (1) or (6). no mass-wise processing: in, denoising of each gray-scale image corresponding to a mass (channel) selected after peak picking is performed. naturally, a channel-wise processing may be criticized as being prone to lose information presented in a combination of channels. in our methods sa and sasa, we never do channel-wise processing but consider the full spectra.fastmap dimension q: as discussed in section 3.1.6, the fastmap dimension q is the most tricky parameter. we have done a computational study investigating the properties of the fastmap projection and observed that increase of q changes the distances between projections, but only until some value. after this value, the distances between projections stay almost unchanged. investigating this question can lead to a way of choosing q, and, more generally, to the way of finding the intrinsic dimension of a set of points. evaluation: the evaluation of produced results is an important problem, especially in an unsupervised framework, where no simple criterion (like total recognition rate) can be computed. we have tested the silhouette criterion of separation between found clusters but have not found correspondence between the value of criterion and the visual quality of the maps. probably, this might be explained by no clear separation between clusters. in general, the evaluation of a spatial segmentation remains an important and unsolved problem in imaging mass spectrometry data processing, where no reference or simulated data are provided yet. other publications on ims segmentation, e.g. , do not consider this question and present their methods as a data mining tool with extensive support from histologists or biologists estimating the quality of the produced segmentation maps. this is explained by the novelty of this problem and the lack of existing problems and research groups solving this problem. certainly, in the nearest future the formal evaluation will be necessary, in particular for comparing results of different segmentation. however, any formal evaluation is a complicated task since it requires the ground truth maps for a complex enough dataset. we are working in this direction and hope to present some results soon. in this article, which is based mostly on work by, our aim was to construct an efficient algorithm delivering segmentation maps of at least comparable quality for the datasets fromwhere comparison is done visually i237  
