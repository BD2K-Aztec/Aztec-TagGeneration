an efficient tof-sims image analysis with spatial correlation and alternating nonâ€“negativity-constrained least squares motivation: advances in analytical instrumentation towards acquiring high-resolution images of mass spectrometry constantly demand efficient approaches for data analysis. this is particularly true of time-of-flight secondary ion mass spectrometry imaging where recent advances enable acquisition of high-resolution data in multiple dimensions. in many applications, the distribution of different species from a sampled surface is spatially continuous in nature and a model that incorporates the spatial correlation across the surface would be preferable to estimations at discrete spatial locations. a key challenge here is the capability to analyse the high-resolution multidimen-sional data to extract relevant information reliably and efficiently. results: we propose a framework based on alternating nonnegativity-constrained least squares which accounts for the spatial correlation across the sample surface. the proposed method also decouples the computational complexity of the estimation procedure from the image resolution, which significantly reduces the processing time. we evaluate the performance of the algorithm with biochemical image datasets generated from mixture of metabolites.imaging mass spectrometry (ims) is an increasingly popular approach in the characterization of biological samples . it is a powerful tool to image surface structure with a mass spectrum measured at each pixel. one ims technique is time-of-flight secondary ion mass spectrometry (tof-sims) with applications in areas as varied as hair care , medical implants and drug delivery systems . it is primarily applied in monitoring the distribution of targeted chemical species, but can also be employed for imaging surfaces in non-targeted analyses, when surface compositions are not well defined, in particular in the analysis of biological systems . however, this latter extension poses several challenges with respect to data deconvolution. multivariate analysis (mva) methods have been used extensively to map large complex spatio-spectral tof-sims data into factors of single components providing insights into the type and distribution of chemical species on a surface. popular mva techniques to describe spatiospectral tof-sims data include principal component analysis (pca) , maximum auto-correlation factor (maf) and multivariate curve resolution (mcr) . the pca is perhaps the most commonly used technique, either as a main analysis step or an initialization step for ma approach. maf is an alternative to pca which is independent of pre-treatment scaling. the method is based on maximizing the autocorrelation between neighbouring pixels. a comparison of the two methods for tof-sims data analysis is reported in, recommending the use of maf when images with low spectral intensity are analysed. the presence of negative peaks in the spectrum computed using pca or maf makes it more difficult to interpret the resulting factorization. mcr optimized by alternating least squares (mcr-als) overcomes this problem by imposing a non-negativity constraint in an iterative optimization process . however, these methods can be computationally expensive when applied to large three-way datasets. the fast combinatorial nonnegativity-constrained least squares (fc-nnls) algorithm (van) is specifically designed to handle such datasets, allowing for significant gains in the speed and computational demands of the optimization process in als applications. despite a substantial performance increase in fc-nnls, the estimation of loadings and scores when decomposing large tof-sims data in an mcr-als algorithm can still be problematic. one limitation is that the complexity of the scores estimation is coupled with the number of image pixels. therefore, an increase in the image resolution of the sample surface leads to increases in the uncertainty and computational demands of the score and loading estimates. this is becoming increasingly important as sophisticated tof-sims images with higher spatial resolution are becoming more widespread . even for a currently typical tof-sims dataset with 128 128 pixels and a spectral mass range up to 1000 da, the implementation of als algorithm with three spectral basis functions contains the estimation of 128 128 3 values in the scores estimation step. this emphasizes the benefit of decoupling the number of pixels in images and the number of parameters. in addition, the progress towards acquisition of image data in voxels as opposed to pixels confers further demand on the analysis time and efficiency of data processing . additionally, in cases where the spatial distribution of compounds in an image is continuous such as chemical samples or samples from a biological cell or a cellular environment, the characteristics at proximate/distant regions on the surface are expected to be highly/weakly correlated. this requires the inclusion of the spatial correlation across the surface in the estimation of scores and loadings from tof-sims data. we propose an approach to mcr-als that incorporates a continuous-over-space formulation which accounts for spatial correlation across the sample surface. additionally, the algorithm does not couple the complexity of the estimation procedure to the resolution of tof-sims images, resulting in a significant reduction in the processing time. we exploit the method of a basis function decomposition of scores images which simplifies the estimation of individual pixel values into a set of weights. these weights scale the continuous basis functions and lie in a significantly lower dimensional space. we set out to examine the algorithm with biochemically relevant model image datasets that were generated from simple mixture of metabolites, as an example.the proposed algorithm was first implemented on pure species to extract discriminatory information from the estimated scores and loadings. the extracted information was then used to perform peak assignment in the computed spectra of tc and tpc mixtures. during this process, the spectral information was summarized into three major peaks that can differentiate different species. this information was also used to examine replicate measurements of each dataset to further evaluate the performance of the algorithm. the total ion images for each dataset are depicted in supplementary. tof-sims images were mapped onto 1 1 in both x and y directions and therefore the spatial aspects of the model can be considered arbitrary. cross-section of the spatial frequency response along the x-axis for tpc mixture is shown in. from this figure, it can be seen that to capture the full spatial bandwidth, c should be set to a high value ( 5:5, shown by blue dashed line),algorithm 1 scores and loadings estimation 1. decomposition:-determine m using pca,-define basis function centres l using equation (16),-define basis function widths r / using equation (17),-construct y using equations (10), (12) and (13). 2. initialization:-initialize the weight matrix, a 0 , as a random dense matrix. 3. scores and loadings estimation:-define stopping condition threshold q,-set k 1, while jja k a k1 jj f q-update the loadings, b k1 , using fc-nnls and equation (11),-update the weight matrix, a k , using fc-nnls and equation (14),-set k k 1, end while-update the loadings, b k1 , using fc-nnls and equation (11). 4. estimation of high resolution scores matrices:-calculate w from equation (15) and the final estimate of b. resulting into a high number of basis functions (a grid of 44 44 with q 2). alternatively, the configuration can be chosen to represent the reconstructed images up to a specified bandwidth to limit the number of basis functions and hence computational demand of the estimation algorithm. we set the cutoff frequency to c 0:85, giving approximately 10 db attenuation from the maximum power spectrum. this is shown by a red circle in. in order to account for the slow roll-off in the frequency response of gaussianbasis functions, the oversampling parameter of q 2 was chosen. using these values in equations (16) and (17) yielded the distance between adjacent basis functions centres d / 0:3 and the width of basis functions r / 0:22. given the spatial domain of interest, a grid of 9 9 equally spaced basis functions can be used to satisfy shannons sampling criterion. with this arrangement, the number of unknown parameters was reduced from m 16 384 to m 81. the pre-processing stage involved normalizing the data to the total ion counts. this was followed by poisson scaling for the systems rank analysis. an initial guess of the number of spectral basis vectors, m, for each poisson-scaled dataset was obtained using pca and the scree test. the scree plot for the first few principal components is shown in. the results suggested three spectral basis vectors for each of t, p and c elements and two and three spectral basis vectors for tc and tpc mixtures, respectively. the proposed algorithm was then applied on tof-sims datasets to estimate loadings and the corresponding scores images. in the estimation procedure, we set m 3 for all pure and mixed species despite the suggested rank of two for tc compound in the pca analysis. the results for scores and loadings estimation for t, p and c components are shown in. the m/z number for dominant peaks are illustrated in the loadings plots where the inset figures show the corresponding ion images in the tof-sims dataset.shows large peaks (sorted in order of decreasing magnitudes) at m=z 180:06, 121.02 and 71.01 for the first factor of component t. for component p, the first factor comprises of large peaks at m=z 164:05, 71.01 and 26.01 . for component c, significant peaks for the first factor are located at m=z 87:02, 41.01, 111.02 and 191.02 . as can be seen, the m h signals for each of the metabolite predominates, but fragment ion contributions also exist. peaks at m=z 26:01; m=z 27:98 and m=z 136:93 are common between second and the third factors of all components. therefore, these m/z values do not contain discriminatory information and can be considered noise in the system. in fact, the corresponding scores images of the second and third factors show noisy structures. also, the peak at m=z 71:01 presents in the first factors. score and loading estimates using als with non-negativity constraint for tpc mixture. (ac) score estimates; (df) loading estimates of t and p and cannot be used to distinguish these species. from this analysis, the characteristic peak for component p can be identified as m=z 164:05, which would be the deprotonated metabolite ion m h . the result of the algorithm for tc mixture is illustrated in. similar to the previous example, we associate the peak at m=z 136:93 into the existence of the noise in the system. the peak at m=z 180:06 of the first factor in component t can be also identified inwith its corresponding scores image illustrated in. the same observation can be made for the component c, where three peaks of the first factor, that is, m=z 41:01, 87.02 and 191.02, can be identified . however, the peaks at m=z 41:01, 87.02 and 111.02 can be putatively identified as fragment ions chco ; c 4 h 7 o respectively. there are also strong peaks at m=z 121:02 and m=z 183:02 for t (and e, respectively) and at m=z 111:02 for c ; however, these peaks are not present in tc and tpc mixtures. it should be noted that the peaks at m=z 41:01 and 87.02 are also present in tc and tpc spectra. although these peaks can provide discriminatory information for the component c, they are fragment ions of the process. the results using appropriate number of spectral basis vectors, that is, m 1 for t, p and c datasets and m 2 for tc dataset, are also provided in supplementary, showing successful identification of different components in each case. the extracted information was also used to perform similar analysis on replicate images of t, p, c, tc and tpc to further examine the performance of the algorithm on discerning different species. in this case, we used the correct number of spectral basis vectors, that is, m 1, 2 and 3, respectively, for each pure replicate measurements, tc replicate measurements and tpc replicate measurements. the results are given in supplementary data, confirming the ability of the proposed algorithm to identify different components. in the case of pure species, the characteristic peak for the component c at m=z 191:02 is dominated by fragment ions, that is, m=z 41:01 and 87.02 (bottom panels of supplementaryf). however, this peak can be clearly identified from tc and tpc mixtures as is shown in supplementary figures s4 and s5. in each experiment, the algorithm was allowed to run for a maximum number of 100 iterations, although typically the change in the weights matrix frobenius norm dropped below 10 5 after less than 20 iterations. we compared ion image estimates from the full model and the reduced model with tof-sims data using the mean (over spectra) of the root mean square error (mrmse) over space. the average mrmse of the image estimates over three replicate measurements are shown in. the slight increase in the error is due to the low-pass action of the basis functions which attenuates the high frequency details of the scores images during the iterative algorithm. a comparison between the convergence of the algorithms when reduced and full models were used is also shown in. note that for 128 128 pixels images and m 3, each iteration of the algorithm takes 65.3 ms for the full model. this is 7.8 ms when the reduced model is used. we also generated images using random numbers with different pixel densities to compare the computation time for the full model (fc-nnls) and the reduced model (algorithm 1 with n 81) using different number of spectral basis vectors. the computation time is approximately 100 times faster when the reduced model is used as is shown in.). the full and reduced models are shown by dotted and dashed lines, respectively  
