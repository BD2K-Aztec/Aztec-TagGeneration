mettailor: dynamic block summary and intensity normalization for robust analysis of mass spectrometry data in metabolomics downloaded from motivation: accurate cross-sample peak alignment and reliable intensity normalization is a critical step for robust quantitative analysis in untargetted metabolomics since tandem mass spectrometry (ms/ms) is rarely used for compound identification. therefore shortcomings in the data processing steps can easily introduce false positives due to misalignments and erroneous normalization adjustments in large sample studies. results: in this work, we developed a software package mettailor featuring two novel data preprocess-ing steps to remedy drawbacks in the existing processing tools. first, we propose a novel dynamic block summarization (dbs) method for correcting misalignments from peak alignment algorithms, which alleviates missing data problem due to misalignments. for the purpose of verifying correct realignments , we propose to use the cross-sample consistency in isotopic intensity ratios as a quality metric. second, we developed a flexible intensity normalization procedure that adjusts normalizing factors against the temporal variations in total ion chromatogram (tic) along the chromatographic retention time (rt). we first evaluated the dbs algorithm using a curated metabolomics dataset, illustrating that the algorithm identifies misaligned peaks and correctly realigns them with good sensitivity. we next demonstrated the dbs algorithm and the rt-based normalization procedure in a large-scale data-set featuring 100 sera samples in primary dengue infection study. although the initial alignment was successful for the majority of peaks, the dbs algorithm still corrected $7000 misaligned peaks in this data and many recovered peaks showed consistent isotopic patterns with the peaks they were realigned to. in addition, the rt-based normalization algorithm efficiently removed visible local variations in tic along the rt, without sacrificing the sensitivity of detecting differentially expressed metabolites. availability and implementation: the r package mettailor is freely available at the sourceforge website http://mettailor.sourceforge.net/.mass spectrometry (ms) coupled with gas or liquid chromatography (gc-ms or lc-ms) is already the technology of choice in the metabolomics literature . in the experiment, hundreds to thousands of compounds elute through the chromatography column at varying rates, resulting in separation of compounds across the retention time (rt). the compounds are then ionized and analysed by the ms, in which the mass to charge ratio (m/z) and the intensity of ions are determined. in the untargeted setting, compound identification is typically achieved by searching the mono isotopic mass of each peak against a large-scale database of compounds by exact mass values, such as the hmdb , massbank and metlin , to name a few. quantitative data analysis is then performed using the corresponding peak intensity or integrated peak area in each sample. despite conceptual similarity, extraction of peak features with precise compound identification has proved to be a challenging task in untargeted metabolomics. in particular, the lack of the identification step via global-scale ms/ms fragmentation makes cross-sample matching of peak feature data, so called alignment, as the most crucial data extraction step. this is because multiple compounds of a similar or identical mass with slightly different chemical structure (isomers) and different elemental composition, can co-elute and they are simultaneously analysed, creating mixed signals. without the ms/ms evidence, the intensity signals for such molecules will be aligned together, being treated as the same compound. on the other hand, when thousands of features are processed across a large number of samples, it is also possible that the same compound can be misaligned across the samples and subsequently treated as different compounds in the statistical analysis stage. hence accurate data extraction and robust preprocessing steps are prerequisite for successful untargeted metabolomics analysis. the general workflow for ms data preprocessing consists of several steps. first, peak picking algorithms are applied to identify the ion chromatograms with robust isotopic patterns and each of them is reported as a peak feature with three-dimensional coordinates (m/ z value, retention time and peak areas/intensities, often aggregated over isotopes and adducts into a major peak feature). next, the peak alignment step removes the variations in both rt and m/z axes for the same compounds across the samples, aligning the extracted peaks to the same m/z and rt grid to a single identifier. the aligned peak intensity data are then further processed by a normalization procedure prior to statistical analysis, to remove the systematic bias introduced during sample preparation and the variation in the ionization efficiency and instrumental analysis. common choices for normalizing metabolomics ms data include total intensity sum (tis) , internal standard calibration (isc) , or a statistical model that combines standards and tis . although the existing open source software packages such as mzmine and xcms perform peak picking and alignment, there is room for further improvement . in our observations, for example, even the most sophisticated multi-sample alignment algorithms have been prone to misalignment error at the individual compound level, especially for less abundant compounds or multiply charged compounds. misalignment tends to happen when (i) signal detection algorithms fail to separate co-eluting compounds, (ii) peak picking algorithms identify incorrect major isotopic peaks or (iii) minor temporal variation outlasts the alignment step by a few seconds of rt or a few decimals in the m/z beyond the tolerance level specified in those algorithms. besides the misalignment issue, the existing methods for data normalization also have limitations. for example, the internal standard measurements can be inaccurate in some samples, or mixed with co-eluting compounds. the tis method may fluctuate due to poor chromatographic separation or the influence of a few dominantly abundant compounds, and it can also be inapplicable when the detected compounds are genuinely heterogeneous between comparison groups. most importantly, the procedures mentioned above are corrections by a single constant, which adjusts all intensity values for global bias only and does not account for temporal or local variations along the rt axis across different samples . to address these two key limitations in the current data processing pipeline, we developed a software package mettailor, which implements two post-extraction processing steps including a method for block-wise quantitative summary and a novel rt-based local normalization procedure.overall, our contribution in this work is to provide an open source software package implementing two data processing steps, as a complimentary tool to remedy some gaps unaddressed by the popular data extraction tools in the context of large sample experiments. there are a number of experimental factors that are unique to ms platforms and the two proposed methods are different from the existing alternatives that had been developed for other-omics platforms such as gene expression microarrays. we provide these tools in a popular r programming environment, and will continue to adapt the tools for constantly evolving instrumentation in the future.  
