ll-achrb: a scalable algorithm for sampling the feasible solution space of metabolic networks motivation: random sampling of the solution space has emerged as a popular tool to explore and infer properties of large metabolic networks. however, conventional sampling approaches commonly used do not eliminate thermodynamically unfeasible loops. results: in order to overcome this limitation, we developed an efficient sampling algorithm called loopless artificially centered hit-and-run on a box (ll-achrb). this algorithm is inspired by the hit-and-run on a box algorithm for uniform sampling from general regions, but employs the directions of choice approach of artificially centered hit-and-run. a novel strategy for generating feasible warmup points improved both sampling efficiency and mixing. ll-achrb shows overall better performance than current strategies to generate feasible flux samples across several models. furthermore, we demonstrate that a failure to eliminate unfeasible loops greatly affects sample statistics, in particular the correlation structure. finally, we discuss recommendations for the interpretation of sampling results and possible algorithmic improvements. availability and implementation: source code for matlab and octave including examples are freely available for download ata diversity of computational methods referred to as constrainedbased methods has been developed to study the characteristics and capabilities of genome-scale models (gems). uniform random sampling of the flux solution space is a popular choice for interrogation of gems without introducing optimality criteria. from evaluation of the impact of physiological constraints on the sampled flux distributions to identification of transcriptional regulation , definition of a flux backbone and correlated reaction sets , uniform sampling has been applied to explore achievable states and emergent properties of networks. more importantly, uniform sampling has emerged as an unbiased tool to assess the capabilities of metabolic reconstructions . for this type of analysis to be valid, a keyand often overlookedassumption is that the flux samples are thermodynamically feasible. gems are mathematically described by the stoichiometry matrix s m n , which encodes the mass balances for m metabolites reacting in n biochemical reactions. the capacities of these reactions are phenomenologically limited by thermodynamic and kinetic constraints in the form of lower lb and upper ub bounds. assuming steady-state for metabolites accumulation, the vector of reactionfluxes v consistent with mass conservation is defined by the following set of constraints (eqs. 1 and 2),the resulting flux space x defines a convex polytope describing the achievable states of the network. sampling from this multi-dimensional body can be efficiently achieved using markov chain monte carlo (mcmc) methods such as the hit-and-run (hr) and the artificially centered hit-and-run (achr) algorithms. the latter method has been particularly preferred for sampling the irregularly shaped solution space of metabolic networks, as it explores elongated directions of x enabling in principle faster mixing. there are, however, additional constraints on v that ensure its thermodynamic feasibility. let us denote n int the matrix storing the null space vectors of the internal reactions described by s int , and dl int the vector of chemical potentials for these reactions. according to the first and second law of thermodynamics, v is thermodynamically feasible if for v int v ,equations (3) and(4) guarantee respectively that the global potential energy of the network is balanced (first law), and that reactions proceed in the opposite direction of chemical potential change (second law). these two equations can be satisfied simultaneously only if the net flux around all closed loops is equal to zero, and hence it is commonly referred as the loopless condition. imposition of this condition generally causes the solution space x loopless to be non-convex, which is much harder to sample and so far no algorithm has been developed to do so. instead, ad-hoc methods using conventional samplers have been used to sample from x and then either remove samples with loopy patterns , or find the nearest feasible flux distribution . both approaches have disadvantages. the first approach may yield few feasible samples making it inefficient in high-dimensional models, whereas the second approach is impractical in large models as it requires the solution of a non-polynomial time milp problem for each flux distribution. here we present a scalable, direct sampling algorithm called loopless artificially centered hit-and-run on a box (ll-achrb). this algorithm is motivated by a recent variation of the hit-andrun algorithm for uniform sampling from general regions (convex and non-convex) termed hit-and-run on a box (hrb) , and employs directions of choice as in achr. the algorithm shows overall better performance than current strategies to generate thermodynamically feasible flux samples in several metabolic models ranging from small-size models to gems. finally, we report significant discrepancies in feasible and unfeasible sample statistics, highlighting the consequences of employing thermodynamically unfeasible samples for statistical inference.exact calculation of the volume of a large polytope is an p-hard problem , which leads to polynomial-time approximate algorithms for convex bodies . these algorithms typically rely on monte carlo sampling methods, and have proven to be particularly useful in the analysis of metabolic networks . however, rigorous enforcement of thermodynamic feasibility of flux samples has so far been overlooked, as it greatly complicates sampling due to the imposition of non-convex constraints (np-hard problem). the significant differences in sample statistics when excluding unfeasible samples highlights that thermodynamic feasibility cannot be ignored without introducing significant errors. here, we developed a scalable algorithm inspired by mature monte carlo samplers to incorporate this condition and generate only feasible samples. ll-achrb outperforms the conventional achr where unfeasible loop laws are present, and even for models without potential unfeasible loop laws, ll-achrb was as fast as achr . mixing is a concern when sampling in complicated spaces. reimers (2015) reported a high frequency of reactions with only zero-flux samples despite a non-zero flux range using achr to sample ijo1366. using ll-achrb, we only found one blocked reaction in the ijo1366 model involved in an unfeasible loop. apart from collecting a bigger sample, the main difference in our approach is the pre-processing of ijo1366, which first (a) compacted linear pathways and (b) removed trace elements from the biomass equation. the former reduces the dimension of the problem, while the latter should make the problem better conditioned. the inaccessible reaction in the core e.coli model (fumarate reductase) highlights that caution still is required when analysing sampling results. the loopless condition dictates that fumarate reductase can only be active under anaerobic conditions and this is indeed consistent with experimental data . in this instance, fumarate reductase activity under anaerobic conditions can only be accurately captured, if the model is deliberately constrained for anaerobic growth, i.e. zero oxygen uptake (supplementarypanel a). another illustrative example of the caution needed when analysing sampling results from ll-achrb are. comparison of sample statistics for the irbc283 (a) and ijo1366r (b) models estimated respectively from 5 10 5 flux samples generated ignoring (achr) and enforcing (ll-achrb) the loopless condition. left-hand side panels compare the normalized flux means for reaction i, i.e. mean divided by flux range range (l i /r i ), whereas the right-hand side panels compare non-redundant pairwise correlation coefficients between reactions i and j (q ij ) the two blocked reactions from iit341 (reversible o-succinylhomoserine lyaseshsl4rand l-threonine deaminasethrd_l) (supplementarypanel b). samples from ll-achrb show these two perfectly coupled reactions to be blocked. by constraining these two reactions to zero, the unfeasible loop is avoided. notably,have also studied this loop and have proposed to manually fix the directionalities of another two perfectly coupled reactions involved in it, namely, phosphotransacetylase (ptar) and acetate kinese (ackr). this measure unblocks thrd_l and shsl4r and allows all reactions to carry flux avoiding the loop, however it massively constrains the flux range of ptar and ackr from 65.926 to 0.0169 mmol/gdcw/h. in this particular case, more experimental evidence is needed to decide between the alternatives. more importantly, these cases underscore the need for careful analysis of sampling results from ll-achrb. we finish by mentioning possible improvements to the algorithm. dehave recently reported efficient procedures for improving the performance of hr by finding an ellipsoid that closely matches the sampling space. by extracting directions from the surface of the matching ellipsoid, the performance of the traditional hr can be greatly improved. this strategy is convenient as hr guarantees convergence to the uniform distribution on the target space as opposed to the nonmarkovian achr directions choice. a combination of this strategy with the present algorithm would confer this desired guarantee; however, it is unclear how well it would scale in the case of a nonconvex space. this will be subject for future research.  
