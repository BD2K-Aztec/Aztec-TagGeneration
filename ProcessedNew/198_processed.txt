genetics and population analysis alchemy: a reliable method for automated snp genotype calling for small batch sizes and highly homozygous populations motivation: the development of new high-throughput genotyping products requires a significant investment in testing and training samples to evaluate and optimize the product before it can be used reliably on new samples. one reason for this is current methods for automated calling of genotypes are based on clustering approaches which require a large number of samples to be analyzed simultaneously, or an extensive training dataset to seed clusters. in systems where inbred samples are of primary interest, current clustering approaches perform poorly due to the inability to clearly identify a heterozygote cluster. results: as part of the development of two custom single nucleotide polymorphism genotyping products for oryza sativa (domestic rice), we have developed a new genotype calling algorithm called alchemy based on statistical modeling of the raw intensity data rather than modelless clustering. a novel feature of the model is the ability to estimate and incorporate inbreeding information on a per sample basis allowing accurate genotyping of both inbred and heterozygous samples even when analyzed simultaneously. since clustering is not used explicitly, alchemy performs well on small sample sizes with accuracy exceeding 99 with as few as 18 samples.the number of single nucleotide polymorphisms (snps) that can be genotyped in a single experiment has increased exponentially in the past 5 years, with costs per data point declining at the same time . this technological advance has been critical to the design and to whom correspondence should be addressed. execution of cost-effective genome wide association studies (gwas) in humans and other well-studied systems . while most catalog products offered by companies such as illumina and affymetrix are developed for human genotyping, the underlying technologies of the assays themselves and the manufacturing methods which produce such high-density products should be transferable to most diploid systems of interest and are currently being adapted for domesticated plants and animals. the development of a custom genotyping product is still an expensive process, especially if re-sequencing for snp discovery must be performed. even with a sufficient snp database on hand, the development of a working assay may require dozens or even hundreds of samples to be run in order to identify which array features are working reliably and which simply do not perform well in the multiplexed environment. human genotyping products from affymetrix and illumina, now in their fifth generation or later, are largely free of snps and probes which did not convert to working assays, as previous generation products have identified these snps empirically and they have been removed from later generation products. however, a first generation custom product may see up to 50 of the intended snp assays fail to generate accurate results, and this may only be determined after 100 or more samples have been run. depending on the number of samples planned for the entire experiment, the cost of the samples needed for development and quality control procedures for custom genotyping products may easily form a significant fraction of the total experiment cost. one limitation in custom genotyping array development is the requirement of many automated genotype calling algorithms such as affymetrixs brlmm-p to have a large number of samples from which three distinct clusters of genotypes (aa, ab, bb) can be reliably identified and clearly distinguished . the methodology in many of these clustering algorithms implicitly assumes the existence of all three clusters. other published methods attempt to statistically test whether or not two or three clusters best describes the data . some more recent methods such as birdseed require 100 or more samples with known genotypes to be assayed in advance to train the algorithm. the brlmm-p algorithm can accept training samples as priors or can be run without priorsin the development of the two genotyping products, we have four types of samples which can be used to evaluate performance of the assays themselves and the alchemy genotype calling method: (i) reference samples, (ii) replicate samples, (iii) oryzasnp samples and (iv) samples which have been re-sequenced by high-throughput short-read sequencing (illumina genomeanalyzer ii) to a sufficient extent to determine the allele at a large majority of snp sites. except where explicitly stated otherwise, all validations were performed comparing either alchemy or the vendors software (beadstudio and brlmm-p) run on the entire collection of 184 illumina assays or 200 affymetrix assays. the reference samples are the two rice lines for which assembled genome sequence is publicly available. the first, nipponbare, is a temperate japonica line which has been extensively sequenced and assembled into high-quality pseudo-molecules . the second, 9311, is an indica variety which has been sequenced by sanger whole-genome shotgun sequencing and assembled using the nipponbare genome sequence as a scaffold . our samples bear the same name as these reference genomes but are not identical to the lines sequenced. as seen inreplicate the expected calls based on the nipponbare sequence to a high degree, but diverge from the 9311 genome sequence. however, since we have many replicates of these samples, we find that there is high concordance across our reference samples and it seems likely that the differences seen between our 9311 and the genome sequence reflect true differences, resulting from different origins of the materials. likewise, the f1 genotypes which we predict from the nipponbare and 9311 genome sequences also show differences with the alchemy calls as a consequence of the divergent 9311 lines. next we looked at the samples run in replicate, including the reference samples above. in the illumina samples, we have seven samples run at least twice (including the 3 reference samples) with all pairs of replicates showing an average concordance of 99.6 and average pairwise mutual call rate (genotype called in both samples) of 95.4 . this is also seen in the affymetrix samples where 22 different samples run at least twice have an average pairwise concordance of 99.5 and average mutual call rate of 92.6. this indicates both the assays themselves and alchemy genotype calls are consistent across many distinct samples. because our snp discovery panel was limited to 20 accessions across five subpopulations of domestic rice and we purposely selected snps that would be informative in at least 2 or more subpopulations where possible, there are no snps in the panel of lines studied here with a minor allele frequency 10. however, it is easy to construct a subset of samples such that a large percentage of snps will have only a single observation of the minor allele homozygote. to do this, we selected one nipponbare control samplefor these lines from the sequence data, we can compare these expected genotypes to alchemy calls. on average, we find a high concordance (average 99.1, call rate 96.3) with some of the lines having lower concordance being those derived from distinct plant materials or having lower coverage depth in re-sequencing (supplementary). taken together, these analyses broadly validate alchemys genotype calls across many different rice samples. next, we asked whether or not alchemy was over-fit to these specific genotyping products. the vendors genotyping algorithms work well for human products and other supported products, but did not perform well out-of-the-box on our custom arrays and our samples as demonstrated above. in the interest of promoting the development of new genotyping products in more systems, we would like to have a genotyping algorithm that performs well across a broad range of vendors, products, systems and sample sets, requiring little or no empirical fine-tuning to obtain high-quality data. to assess alchemys performance on a non-rice dataset, we obtained the publicly available hapmap phase ii published genotypes and the affymetrix human 500k genechip .cel files that were run on these same samples and ran alchemy and brlmm-p . as expected, brlmm-p performs very well as it, and its predecessor brlmm, has been developed and tuned for affymetrix human genotyping products. although alchemy does not perform as well as brlmm-p on human hapmap samples, it still performs very well even without specific tuning or trial-anderror adjustments to improve accuracy or call rate. these results, taken together with the results above showing strong performance on two very different technologies, suggests alchemy is a generalized method with broad applications, especially for custom products where fine-tuned specialized algorithms are not available. finally, since custom products may require optimization of molecular techniques and protocols to obtain optimal results, we wanted to develop a method which produced accurate and usable results even if the total sample size was small. to demonstrate alchemys ability to call small sample sizes, we ran alchemy as well as the vendors software on a series of sample subsets and assessed the accuracy and call rates for our three reference samples: nipponbare, 9311 and the nipponbare x 9311 f1. additionally, we ran each of the three reference samples alone to assess performance on a single sample. because of the unfortunate discrepancy between our 9311 line and the 9311 line which was sequenced, we gauge accuracy on the basis of agreement with the consensus alchemy calls for these samples across all replicates in the full dataset but restrict ourselves to snps with consensus calls which are consistent with mendelian transmission to the f1 in the full dataset. in, we find that alchemy quickly attains 99 accuracy with as few as 18 samples (see alsofor a graphical representation of). additionally, it performs very well on either homozygote sample alone, but quite poorly on the heterozygote sample alone. in contrast, brlmm-p performs very poorly on any of the three reference samples alone and poorly on small samples sizes. brlmm-p accuracy increases as sample size increases, as expected, but surprisingly, call rates decline. similar results are observed with illumina beadstudio, except call rates do not decline with larger sample size and beadstudio performs very well on either homozygote sample alone, but not with the heterozygote sample alone (supplementary).the design of alchemy was motivated primarily by two concerns:(1) the poor performance of the vendors software on inbred sample sets and (2) the requirement for a large number of samples to be simultaneously analyzed to obtain accurate results. as mentioned previously, the two concerns are related, as the main reason many samples are required for clustering algorithms is to ensure that each genotype cluster is well represented allowing its location and boundaries to be well defined. thus, if heterozygotes are rare or absent in the data due to inbreeding, the heterozygote cluster cannot be reliably identified even if large numbers of inbred samples are used. to address this, we have proposed a statistical model to describe the raw intensity data which is the basic observation of both affymetrix and illumina genotyping platforms. the model is capable of making an inference even if only a single sample is analyzed, but the parameters of the model are refined and optimized when several samples are available for simultaneous inference. in addressing concern (2), this approach is shown to be highly successful, with alchemy obtaining 99 accuracy with as few as 18 samples on the affymetrix 44k platform, and larger number of samples continuing to improve call rates. additionally, the statistical treatment of the problem permits inbreeding to be explicitly considered and incorporated into the model in an appropriate way. simultaneously estimating and optimizing the inbreeding coefficient on a per-sample basis allows both outbred and inbred samples to be analyzed simultaneously and improves both accuracy and call rates.although not studied extensively here, the posterior call probability produced by alchemy as a quality metric can conceivably be used directly in downstream population genetic and quantitative genetic statistical analyses. for the rice datasets and the human hapmap dataset, the signal-to-noise ratio of the intensity data is strong enough that for most snps there is little uncertainty in the genotype call. however, in noisier data, incorporating the probability of error estimated by alchemy for genotype calls into statistical analyses may allow for more accurate population genetic inferences and improve both sensitivity and specificity of gwas. we caution, however, that these probabilities are subjective due to the use of a bayesian model and may not precisely correspond to actual observed error rates. the bayesian model not only presumes the bimodal intensity distribution but also hwe (with inbreeding adjustment) of genotype frequencies across the sample set. violation of either model assumption will introduce deviations between expected error rates [formed by summing (1p) were p is the posterior probability of the call] versus observed error rates. this is particularly relevant for our rice samples which come from a highly structured population where deviations from hwe frequencies are expected not only due to inbreeding but also from differences in allele frequencies between subpopulations. the results presented here show that alchemys performance is superior to either vendors standard software on the two rice genotyping products considered. additionally, the strong performance on human hapmap data suggests that alchemy may work well on a wide range of products. we have also tested alchemy on currently unpublished data from dogs in both affymetrix and illumina products and found a consistent high level of performance at or exceeding the levels reported here. while brlmm-p outperforms alchemy on the hapmap samples, it is important to note that we did not attempt to tune or alter alchemy for improved performance on hapmap as the purpose was to test whether or not alchemy is already over-fit to the rice genotyping arrays for which it was developed. compared to many other genotype calling software packages, alchemy has relatively few options to tune its performance for specific datasets. in part, we consider this a feature rather than a weakness, as the multitude of tuning parameters for programs such as brlmm-p are bewildering to the user and potentiallyillumina 1536 (rice) affymetrix 44k (rice) affymetrix 500k (human hapmap)  
