genome analysis spanner: taxonomic assignment of sequences using pyramid matching of similarity profiles background: homology-based taxonomic assignment is impeded by differences between the unassigned read and reference database, forcing a rank-specific classification to the closest (and possibly incorrect) reference lineage. this assignment may be correct only to a general rank (e.g. order) and incorrect below that rank (e.g. family and genus). algorithms like lca avoid this by varying the predicted taxo-nomic rank based on matches to a set of taxonomic references. lca and related approaches can be conservative, especially if best matches are taxonomically widespread because of events such as lateral gene transfer (lgt). results: our extension to lca called spanner (similarity profile anno-tater) uses the set of best homology matches (the lca profile) for a given sequence and compares this profile with a set of profiles inferred from taxonomic reference organisms. spanner provides an assignment that is less sensitive to lgt and other confounding phenomena. in a series of trials on real and artificial datasets, spanner outperformed lca-style algorithms in terms of taxonomic precision and outperformed best blast at certain levels of taxonomic novelty in the dataset. we identify examples where lca made an overly conservative prediction, but spanner produced a more precise and correct prediction. conclusions: by using profiles of homology matches to represent patterns of genomic similarity that arise because of vertical and lateral inheritance, spanner offers an effective compromise between taxo-nomic assignment based on best blast scores, and the conservative approach of lca and similar approaches. availability: c source code and binaries are freely available atan important step in metagenomic sequencing of environmental dna is the taxonomic assignment of sequences to predict which genes are present in which members of a microbial sample. however, unassembled dna sequence reads from current platforms are typically short (5600 bp) and difficult to classify . accurate supervised classification of metagenomic sequences depends on the availability of a database of reference genomes that contains close relatives of the organisms in a microbial sample. if an organism in a community has sequenced relatives only at higher taxonomic ranks, such as class, then classification to a more precise rank will be impossible, and even assignment to the correct phylum will be difficult because of the extensive variation in dna residue composition and gene content within most phyla . although best blast matching has been used to assign taxonomy in some metagenomic studies, this approach will fail if the correct genome is not present in the reference database. in such a case, blast will assign taxonomy that is correct only to a certain taxonomic rank (e.g. family) and incorrect below that rank (e.g. genus and species). when a sample contains a mixture of microbes with varying degrees of taxonomic novelty, it is desirable to incorporate a measure of confidence that labels some fragments with precise ranks and others with more general ranks (i.e. a rank-flexible classifier:). to overcome the limitations of best blast assignment, megan introduced the lca (lowest common ancestor) algorithm to consider the full set of blast matches when assigning a read to a particular taxonomic rank and group. lca assigns reads to the lowest taxonomic rank that is shared by all homology matches within a range of bitscores defined by the value p (0 p 1). the blast matches with a bitscore greater than p the best bitscore will be used to generate a set (which we term here an lca profile) of blast matches with the highest similarity. this avoids overspecific assignment of a read to a lineage in the reference database by classifying the read to a higher taxonomic level (e.g. by assigning to the rank of family instead of species, if many different species and genera have matches that fall in the interval defined by p), although assignment may still be too specific if this higher taxonomic level still does not encompass the taxonomy of the read. one limitation of lca is the potential presence of distant taxonomic matches in the blast lca profile. for example, lateral gene transfer (lgt) involves the acquisition of genes from a potentially distantly related donor organism by a recipient. at the time of transfer, donor and recipient copies of the sequence will be identical. the two gene copies can subsequently diverge, but will remain as sisters in a phylogenetic tree and appear similar in a list of blast results, potentially leading to the inclusion of both in an lca profile. the presence of even a single distantly related taxonomic group in an lca profile will cause the lca algorithm to assign a very high taxonomic rank to the result, for example, an lgt event between two phyla could lead to a to whom correspondence should be addressed the author(s) 2013. published by oxford university press. this is an open access article distributed under the terms of the creative commons attribution license (http://creativecommons.org/licenses/by/3.0/), which permits unrestricted reuse, distribution, and reproduction in any medium, provided the original work is properly cited. sequence read being assigned to the rank of domain (e.g. bacteria) or higher (e.g. cellular organisms). also, the effect of different evolutionary rates of different genes on classification has not been explored in depth: slowly evolving genes are likely to have more hits within a given p threshold, and more conservative taxonomic assignments. modifications to the lca algorithm have been proposed. sort-items fixes p at 0.9. instead of then taking the lca of the retained matches, a second blast search is done using the best blast match as the query, and all sequences above the p threshold plus the original query sequence as the new reference. only the aligned section of each sequence is used in this reciprocal search. the lca of all blast matches that are better than the match to the original query is used as the assignment. carma3 is similar to sort-items in using the aligned section of each sequence in the reciprocal search, the bitscores of which define ranges at each taxonomic rank of the reciprocal query lineage. the bitscore of the original query falls into one of these ranges, and assignment is made at that rank. here, we describe a new rank-flexible algorithm for taxonomic assignment called spanner. instead of assigning taxonomy based on a range of matches to sequences from a set of reference genomes, spanner considers the similarity of the overall lca profile of a sequence to a reference database of lca profiles similarly constructed from the database of reference genomes. classification of a query dna sequence is based on the taxonomic diversity of its best-matching lca profiles. the similarity of the two lca profiles (query and reference) is measured using the pyramid match kernel , which compares lca profiles at multiple levels of granularity to generate an overall similarity score. the lowest common ancestor of all lca profile matches within a range of pyramid scores (denoted by y) is used as the assignment, with any lca profile match greater than the best match y (0 y 1) included in this range. taxonomic assignments are, therefore, based on the similarity between the homology matching pattern of a sequence and patterns of proteins from the reference database of microbial genomes. if many proteins from a particular genome have unusual patterns of taxonomic similarity because of lgt or other evolutionary or statistical phenomena, then metagenomic reads with similar affinity patterns will be assigned in a manner that is not overly conservative. here, we validate the spanner approach with a test set comprising 334 microbial genomes in a manner similar to brady and salzberg (2009) and a metagenome sampled from a dechlorinating community of microorganisms .  
