data and text mining correction of mass calibration gaps in liquid chromatographyâ€“mass spectrometry metabolomics data motivation: high mass accuracy is an important goal in liquid chro-matographymass spectrometry experiments. some manufacturers employ a mass calibration system that regularly switches between the analyte and a standard reference compound, and leads to gaps in the analyte data. we present a method for correction of such gaps in global molecular profiling applications such as metabolomics. we demonstrate that it improves peak detection and quantification, successfully recovering the expected number of peaks and intensity distribution in an example metabolomics dataset. availability and implementation: available in xcms versions 1.23.3 and higher. distributed via bioconductor under gnu general public license.liquid chromatographymass spectrometry (lcms) has become a widely used methodology in metabolomics. profiles generated by this method are highly complex and many software packages have been designed to analyse this data [e.g. mzmine, xcms (. these typically employ a peakpicking algorithm for selection of peaks and removal of noise. peaks are then matched between samples, correcting small drifts in retention time (rt) and the final result is a table of the integrated intensities of each peak in each sample. an important goal in lcms experiments is the accurate measurement of the mass to charge ratio (m/z). usually, a mass calibration method is used throughout the experiment to keep the m/z deviation within the desired range. ms manufacturers employ different methods to calibrate their instruments. some manufacturers use a switching method, which regularly changes the ms input between the analyte and a standard reference . switching the flow in this way can avoid the problem of ionization suppression encountered with continuous flow methods. however, changing the flow to the lock mass spray temporarily stops the analyte from being detected, resulting in gaps in the analyte data. these lock mass gaps can cause a single peak to be split into several smaller peaks , confusing the process of peak matching. to whom correspondence should be addressed. even if the peak is detected correctly, the true intensity will be underestimated due to the gap. the situation is further exacerbated by rt drifts across samples, which will cause the position of the gap within the peak to shift. the peak detection, multiplicity and loss in intensity will thus vary depending on where the gap is in the peak. this variability can lead to both false positives and false negatives in peak detection, and inaccurate intensity estimation. while most vendor software is presumed to take account of such elements of ms design, this is not true of widely used and community supported open source software for lcms data processing. we have developed a method that recovers the lost intensity by filling in the gap. the method greatly reduces errors in peak detection, matching and intensity estimation and is freely available as a built-in function stitch, for the xcms package.to test the method, data were acquired for a single sample at two different lmis. a first acquisition at an lmi of 1000 scans (givinga total of three lock mass scans over the entire acquisition) gave a dataset where few peaks would be affected by lock mass gaps. this approximates data unaffected by the lock mass gap problem. a second acquisition with an lmi of 50 scans (71 lock mass scans in total) was chosen to correspond to a typical metabolomics protocol. we then compared the xcms output for the lmi 50 data with and without correction with the lmi 1000 data without correction. to illustrate the success of the method, we extracted two example peaks from the data . the first peak (m/z = 307.08, rt = 126 s) demonstrates how the correction algorithm improves peak detection. the bottom panel of the figure, plotted in black, clearly shows two scans missing due to lock mass acquisition; these are corrected (shown dashed in red) resulting in a peak with very similar shape and intensity to that in the lmi 1000 data (top panel). this peak is detected by the software in the lmi 1000 and lmi 50 corrected data, but not in the uncorrected lmi 50 data. in the second example, the peak (m/z = 308.08, rt = 42 s) is detected in all three datasets. however, in the uncorrected lmi 50 the peak is much shorter, 3 s compared to 5 s in the lmi 1000 and the corrected lmi 50. the gap effectively leads to a shorter peak and this reduces the intensity estimate by 21 compared to the undamaged lmi 1000 data (lmi 50 intensity = 3146, lmi 1000 intensity = 3987). applying gap correction results in an intensity estimate just 1 higher than the lmi 1000 data (lmi 50 corrected intensity = 4030). many peak detection algorithms use the shape of the peak to help identify it. with the correction method, this shape is recovered, and more peaks are found. using the same parameter settings, 2784 peaks were detected in the lmi 1000 data, while only 2625 peaks were detected in the lmi 50 data, a decrease of 6. in the lmi 50 corrected data, 2869 peaks were found, a gain of 3 over the lmi 1000 data. after grouping, 2761 peak groups were matched between the three datasets. extracted ion chromatograms were visually inspected, confirming successful gap correction (supplementary material 1). the correction method brought the global intensity distribution closer to the undamaged lmi 1000 data. the median intensity dropped from 772 in the lmi 1000 data to 700 in the lmi 50 data (a 9 reduction), but was recovered with the correction method to 775 in the corrected lmi 50 data (0.4 difference from the lmi 1000 data). as a further demonstration of the success of the correction method, peaks eluting while lock mass correction occurred were manually identified. for the 300 peaks with lowest m/z, 78 were affected by gaps. the fractional difference in intensity between the lmi 50 and lmi 1000 data was computed for both uncorrected (f u ) and corrected (f c ) data for both gapped and non-gapped peaks. gap correction resulted in a distribution for gapped peaks much closer to that for non-gapped peaks than for uncorrected data (median f u =6.73 and 3.26 and f c = 4.80 and 3.13 for gapped and non-gapped peaks respectively, see supplementary material). the stitch function allows peak detection algorithms to accurately find and integrate each peak. we note that the method is generic and can be applied to data derived from any lcms experiment, e.g. in metabolomics or proteomics. we have implemented the algorithm within xcms, one of the most widely used freely available lcms data processing packages. in summary, our gap correction method allows lcms data acquired with lock mass gaps to be analysed with a higher degree of accuracy and confidence than currently possible.  
